<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶æ ¼å¼è½¬æ¢å·¥å…· - MVPç‰ˆæœ¬</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-12 px-4">
    <div class="max-w-4xl mx-auto">
        <div class="text-center mb-12">
            <h1 class="text-4xl font-bold text-gray-900 mb-4">
                æ–‡ä»¶æ ¼å¼è½¬æ¢å·¥å…·
            </h1>
            <p class="text-lg text-gray-600">
                æ”¯æŒ Wordã€PDFã€JPG æ ¼å¼ä¹‹é—´çš„ç›¸äº’è½¬æ¢ (MVPç‰ˆæœ¬)
            </p>
            <div class="mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                <p class="text-green-800 text-sm">
                    <strong>å·²å®ç°åŠŸèƒ½ï¼š</strong> å›¾ç‰‡â†”PDF åŒå‘è½¬æ¢ï¼ŒPDFâ†’JPG è½¬æ¢
                </p>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-lg p-8">
            <!-- æœåŠ¡å™¨çŠ¶æ€ -->
            <div class="mb-6">
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                    <span class="text-sm font-medium">åç«¯æœåŠ¡çŠ¶æ€:</span>
                    <span id="serverStatus" class="text-sm">æ£€æŸ¥ä¸­...</span>
                </div>
            </div>

            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="mb-8">
                <h2 class="text-xl font-semibold mb-4">1. é€‰æ‹©æ–‡ä»¶</h2>
                <div id="dropzone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer transition-colors hover:border-gray-400">
                    <input type="file" id="fileInput" class="hidden" accept=".docx,.doc,.pdf,.jpg,.jpeg,.png">
                    <p class="text-gray-600">
                        ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ
                    </p>
                    <p class="text-sm text-gray-400 mt-2">
                        æ”¯æŒ .docx, .doc, .pdf, .jpg, .png æ ¼å¼ï¼Œæœ€å¤§ 50MB
                    </p>
                </div>
                <div id="fileInfo" class="mt-4 hidden">
                    <p id="fileName" class="text-green-600 font-medium"></p>
                    <p id="fileSize" class="text-sm text-gray-500"></p>
                </div>
            </div>

            <!-- æ ¼å¼é€‰æ‹© -->
            <div id="formatSelection" class="mb-8 hidden">
                <h2 class="text-xl font-semibold mb-4">2. é€‰æ‹©ç›®æ ‡æ ¼å¼</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <button class="format-btn p-4 rounded-lg border-2 border-gray-200 hover:border-gray-300 transition-colors" data-format="pdf">
                        <div class="text-center">
                            <div class="text-2xl mb-2">ğŸ“„</div>
                            <div>PDF</div>
                        </div>
                    </button>
                    <button class="format-btn p-4 rounded-lg border-2 border-gray-200 hover:border-gray-300 transition-colors" data-format="jpg">
                        <div class="text-center">
                            <div class="text-2xl mb-2">ğŸ–¼ï¸</div>
                            <div>JPG</div>
                        </div>
                    </button>
                    <button class="format-btn p-4 rounded-lg border-2 border-gray-200 hover:border-gray-300 transition-colors" data-format="docx">
                        <div class="text-center">
                            <div class="text-2xl mb-2">ğŸ“</div>
                            <div>Word</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- è½¬æ¢æ–¹å¼é€‰æ‹© -->
            <div id="conversionMethod" class="mb-8 hidden">
                <h2 class="text-xl font-semibold mb-4">3. é€‰æ‹©è½¬æ¢æ–¹å¼</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="frontendConvert" class="p-4 rounded-lg border-2 border-blue-200 bg-blue-50 hover:bg-blue-100 transition-colors">
                        <div class="text-center">
                            <div class="text-lg font-medium text-blue-700">å‰ç«¯è½¬æ¢</div>
                            <div class="text-sm text-blue-600 mt-1">å¿«é€Ÿï¼Œä»…æ”¯æŒå›¾ç‰‡è½¬PDF</div>
                        </div>
                    </button>
                    <button id="backendConvert" class="p-4 rounded-lg border-2 border-gray-200 hover:border-gray-300 transition-colors">
                        <div class="text-center">
                            <div class="text-lg font-medium text-gray-700">åç«¯è½¬æ¢</div>
                            <div class="text-sm text-gray-600 mt-1">æ”¯æŒPDFè½¬å›¾ç‰‡ï¼Œå›¾ç‰‡è½¬PDF</div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- è½¬æ¢æŒ‰é’® -->
            <div id="convertSection" class="mb-8 hidden">
                <button id="convertBtn" class="w-full bg-blue-600 text-white py-3 px-6 rounded-lg font-medium hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                    å¼€å§‹è½¬æ¢
                </button>
            </div>

            <!-- è¿›åº¦æ˜¾ç¤º -->
            <div id="progress" class="mb-8 hidden">
                <div class="bg-gray-200 rounded-full h-2">
                    <div id="progressBar" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
                <p id="progressText" class="text-sm text-gray-600 mt-2">å‡†å¤‡ä¸­...</p>
            </div>

            <!-- é”™è¯¯ä¿¡æ¯ -->
            <div id="errorMessage" class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg hidden">
                <p class="text-red-600"></p>
            </div>

            <!-- è½¬æ¢ç»“æœ -->
            <div id="result" class="p-4 bg-green-50 border border-green-200 rounded-lg hidden">
                <p class="text-green-600 mb-4">è½¬æ¢æˆåŠŸï¼</p>
                <button id="downloadBtn" class="bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                    ä¸‹è½½æ–‡ä»¶
                </button>
            </div>
        </div>

        <!-- åŠŸèƒ½è¯´æ˜ -->
        <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold mb-4">åŠŸèƒ½è¯´æ˜</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <h4 class="font-medium text-green-600 mb-2">âœ… å·²å®ç°</h4>
                    <ul class="space-y-1 text-gray-600">
                        <li>â€¢ å›¾ç‰‡è½¬PDF (å‰ç«¯+åç«¯)</li>
                        <li>â€¢ PDFè½¬å›¾ç‰‡ (åç«¯)</li>
                        <li>â€¢ æ–‡ä»¶ä¸Šä¼ ä¸‹è½½</li>
                        <li>â€¢ å®Œæ•´APIæ¡†æ¶</li>
                    </ul>
                </div>
                <div>
                    <h4 class="font-medium text-yellow-600 mb-2">ğŸš§ å¼€å‘ä¸­</h4>
                    <ul class="space-y-1 text-gray-600">
                        <li>â€¢ Wordè½¬PDF</li>
                        <li>â€¢ å›¾ç‰‡è½¬Word</li>
                        <li>â€¢ æ‰¹é‡è½¬æ¢</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let selectedFormat = null;
        let conversionMode = 'frontend';

        // DOMå…ƒç´ 
        const elements = {
            serverStatus: document.getElementById('serverStatus'),
            fileInput: document.getElementById('fileInput'),
            dropzone: document.getElementById('dropzone'),
            fileInfo: document.getElementById('fileInfo'),
            fileName: document.getElementById('fileName'),
            fileSize: document.getElementById('fileSize'),
            formatSelection: document.getElementById('formatSelection'),
            conversionMethod: document.getElementById('conversionMethod'),
            convertSection: document.getElementById('convertSection'),
            progress: document.getElementById('progress'),
            progressBar: document.getElementById('progressBar'),
            progressText: document.getElementById('progressText'),
            errorMessage: document.getElementById('errorMessage'),
            result: document.getElementById('result'),
            convertBtn: document.getElementById('convertBtn'),
            frontendConvert: document.getElementById('frontendConvert'),
            backendConvert: document.getElementById('backendConvert')
        };

        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        async function checkServerStatus() {
            try {
                const response = await fetch('http://localhost:3001/');
                if (response.ok) {
                    elements.serverStatus.innerHTML = '<span class="text-green-600">âœ… åœ¨çº¿</span>';
                } else {
                    elements.serverStatus.innerHTML = '<span class="text-red-600">âŒ ç¦»çº¿</span>';
                }
            } catch (error) {
                elements.serverStatus.innerHTML = '<span class="text-red-600">âŒ ç¦»çº¿</span>';
            }
        }

        // åˆå§‹åŒ–
        checkServerStatus();

        // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
        elements.dropzone.addEventListener('click', () => elements.fileInput.click());
        elements.fileInput.addEventListener('change', handleFileSelect);

        // æ‹–æ‹½äº‹ä»¶
        elements.dropzone.addEventListener('dragover', handleDragOver);
        elements.dropzone.addEventListener('drop', handleDrop);
        elements.dropzone.addEventListener('dragenter', handleDragEnter);
        elements.dropzone.addEventListener('dragleave', handleDragLeave);

        function handleDragOver(event) {
            event.preventDefault();
            event.stopPropagation();
        }

        function handleDragEnter(event) {
            event.preventDefault();
            event.stopPropagation();
            elements.dropzone.classList.add('border-blue-400', 'bg-blue-50');
            elements.dropzone.classList.remove('border-gray-300');
        }

        function handleDragLeave(event) {
            event.preventDefault();
            event.stopPropagation();
            // åªæœ‰å½“ç¦»å¼€æ•´ä¸ªdropzoneåŒºåŸŸæ—¶æ‰ç§»é™¤æ ·å¼
            if (!elements.dropzone.contains(event.relatedTarget)) {
                elements.dropzone.classList.remove('border-blue-400', 'bg-blue-50');
                elements.dropzone.classList.add('border-gray-300');
            }
        }

        function handleDrop(event) {
            event.preventDefault();
            event.stopPropagation();

            // æ¢å¤æ ·å¼
            elements.dropzone.classList.remove('border-blue-400', 'bg-blue-50');
            elements.dropzone.classList.add('border-gray-300');

            const files = event.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                handleFileSelect({ target: { files: [file] } });
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                selectedFile = file;
                elements.fileName.textContent = file.name;
                elements.fileSize.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;
                elements.fileInfo.classList.remove('hidden');
                elements.formatSelection.classList.remove('hidden');
                updateFormatOptions(file.type);

                console.log('æ–‡ä»¶é€‰æ‹©æˆåŠŸ:', file.name, file.type, file.size);
            }
        }

        function updateFormatOptions(fileType) {
            const formatBtns = document.querySelectorAll('.format-btn');
            formatBtns.forEach(btn => {
                btn.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-700');
                btn.classList.add('border-gray-200');
                btn.style.display = 'none'; // é»˜è®¤éšè—æ‰€æœ‰é€‰é¡¹
            });

            // æ ¹æ®æ–‡ä»¶ç±»å‹æ˜¾ç¤ºå¯ç”¨æ ¼å¼
            if (fileType.includes('image')) {
                // å›¾ç‰‡æ–‡ä»¶å¯ä»¥è½¬æ¢ä¸ºPDF
                formatBtns.forEach(btn => {
                    if (btn.dataset.format === 'pdf') {
                        btn.style.display = 'block';
                    }
                });
            } else if (fileType.includes('pdf')) {
                // PDFæ–‡ä»¶å¯ä»¥è½¬æ¢ä¸ºå›¾ç‰‡
                formatBtns.forEach(btn => {
                    if (btn.dataset.format === 'jpg') {
                        btn.style.display = 'block';
                    }
                });
            } else if (fileType.includes('word') || fileType.includes('document')) {
                // Wordæ–‡ä»¶å¯ä»¥è½¬æ¢ä¸ºPDF
                formatBtns.forEach(btn => {
                    if (btn.dataset.format === 'pdf') {
                        btn.style.display = 'block';
                    }
                });
            }
        }

        // æ ¼å¼é€‰æ‹©äº‹ä»¶
        document.querySelectorAll('.format-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.format-btn').forEach(b => {
                    b.classList.remove('border-blue-500', 'bg-blue-50', 'text-blue-700');
                    b.classList.add('border-gray-200');
                });
                
                btn.classList.remove('border-gray-200');
                btn.classList.add('border-blue-500', 'bg-blue-50', 'text-blue-700');
                
                selectedFormat = btn.dataset.format;
                elements.conversionMethod.classList.remove('hidden');
            });
        });

        // è½¬æ¢æ–¹å¼é€‰æ‹©
        elements.frontendConvert.addEventListener('click', () => {
            conversionMode = 'frontend';
            elements.frontendConvert.classList.add('border-blue-500', 'bg-blue-100');
            elements.backendConvert.classList.remove('border-blue-500', 'bg-blue-100');
            elements.convertSection.classList.remove('hidden');
        });

        elements.backendConvert.addEventListener('click', () => {
            conversionMode = 'backend';
            elements.backendConvert.classList.add('border-blue-500', 'bg-blue-100');
            elements.frontendConvert.classList.remove('border-blue-500', 'bg-blue-100');
            elements.convertSection.classList.remove('hidden');
        });

        // è½¬æ¢åŠŸèƒ½
        elements.convertBtn.addEventListener('click', async () => {
            if (!selectedFile || !selectedFormat) {
                showError('è¯·é€‰æ‹©æ–‡ä»¶å’Œç›®æ ‡æ ¼å¼');
                return;
            }

            if (conversionMode === 'frontend') {
                await convertFrontend();
            } else {
                await convertBackend();
            }
        });

        async function convertFrontend() {
            if (selectedFile.type.includes('image') && selectedFormat === 'pdf') {
                await convertImageToPdfFrontend();
            } else if (selectedFile.type.includes('pdf')) {
                showError('PDFè½¬å›¾ç‰‡éœ€è¦ä½¿ç”¨åç«¯è½¬æ¢æ¨¡å¼');
            } else {
                showError('å‰ç«¯æ¨¡å¼ç›®å‰åªæ”¯æŒå›¾ç‰‡è½¬PDFï¼Œå…¶ä»–è½¬æ¢è¯·ä½¿ç”¨åç«¯æ¨¡å¼');
            }
        }

        async function convertBackend() {
            try {
                showProgress('ä¸Šä¼ æ–‡ä»¶...', 25);

                // ä¸Šä¼ æ–‡ä»¶
                const formData = new FormData();
                formData.append('file', selectedFile);

                const uploadResponse = await fetch('http://localhost:3001/api/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) {
                    throw new Error('æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }

                const uploadResult = await uploadResponse.json();
                showProgress('è½¬æ¢ä¸­...', 75);

                // è½¬æ¢æ–‡ä»¶
                const convertResponse = await fetch('http://localhost:3001/api/convert', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        filename: uploadResult.filename,
                        targetFormat: selectedFormat
                    })
                });

                if (!convertResponse.ok) {
                    const errorData = await convertResponse.json();
                    throw new Error(errorData.error || 'è½¬æ¢å¤±è´¥');
                }

                const convertResult = await convertResponse.json();
                showProgress('å®Œæˆ!', 100);

                setTimeout(() => {
                    // ä¸‹è½½æ–‡ä»¶
                    window.open(`http://localhost:3001${convertResult.downloadUrl}`, '_blank');
                    showSuccess();
                    hideProgress();
                }, 500);

            } catch (error) {
                hideProgress();
                showError('åç«¯è½¬æ¢å¤±è´¥: ' + error.message);
            }
        }

        async function convertImageToPdfFrontend() {
            try {
                showProgress('æ­£åœ¨å¤„ç†å›¾ç‰‡...', 25);
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    showProgress('æ­£åœ¨ç”ŸæˆPDF...', 75);
                    
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        
                        const imgData = canvas.toDataURL('image/jpeg', 0.95);
                        
                        // è®¡ç®—é€‚åˆA4é¡µé¢çš„å°ºå¯¸
                        const a4Width = 210;
                        const a4Height = 297;
                        const ratio = Math.min(a4Width / (img.width * 0.264583), a4Height / (img.height * 0.264583));
                        
                        const finalWidth = img.width * 0.264583 * ratio;
                        const finalHeight = img.height * 0.264583 * ratio;
                        
                        pdf.addImage(imgData, 'JPEG', 10, 10, finalWidth, finalHeight);
                        
                        showProgress('å®Œæˆ!', 100);
                        
                        setTimeout(() => {
                            const fileName = selectedFile.name.replace(/\.[^/.]+$/, "") + '.pdf';
                            pdf.save(fileName);
                            showSuccess();
                            hideProgress();
                        }, 500);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(selectedFile);
                
            } catch (error) {
                hideProgress();
                showError('è½¬æ¢å¤±è´¥: ' + error.message);
            }
        }

        function showProgress(text, percent) {
            elements.progress.classList.remove('hidden');
            elements.progressBar.style.width = percent + '%';
            elements.progressText.textContent = text;
        }

        function hideProgress() {
            elements.progress.classList.add('hidden');
        }

        function showError(message) {
            elements.errorMessage.querySelector('p').textContent = message;
            elements.errorMessage.classList.remove('hidden');
            elements.result.classList.add('hidden');
        }

        function showSuccess() {
            elements.result.classList.remove('hidden');
            elements.errorMessage.classList.add('hidden');
        }
    </script>
</body>
</html>
